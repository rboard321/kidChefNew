rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isParentOfKid(kidId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/kidProfiles/$(kidId)) &&
        isOwnerOfParentProfile(get(/databases/$(database)/documents/kidProfiles/$(kidId)).data.parentId);
    }

    function isOwnerOfParentProfile(parentId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/parentProfiles/$(parentId)) &&
        get(/databases/$(database)/documents/parentProfiles/$(parentId)).data.userId == request.auth.uid;
    }

    // Legacy User Profiles (for backward compatibility during migration)
    match /userProfiles/{userId} {
      allow read, write: if isOwner(userId);
      allow create: if isAuthenticated() && userId == request.auth.uid;
      // Temporary: Allow querying during migration only
      allow list: if isAuthenticated();
    }

    // Parent Profiles - only the authenticated user can access their own profile
    match /parentProfiles/{parentId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Allow listing for queries; read rules still enforce ownership
      allow list: if isAuthenticated();
    }


    // Kid Profiles - only the parent can manage their kids
    match /kidProfiles/{kidId} {
      allow read: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
      allow create: if isAuthenticated() &&
        isOwnerOfParentProfile(request.resource.data.parentId);
      allow update: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId) &&
        request.resource.data.parentId == resource.data.parentId;
      allow delete: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
      allow list: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
    }

    // Recipes - only owners can manage their recipes (parentId-only, clean security)
    match /recipes/{recipeId} {
      allow read: if isAuthenticated() && (
        // Owner via parentId (required - clean security)
        resource.data.parentId != null && isOwnerOfParentProfile(resource.data.parentId)
      );
      allow create: if isAuthenticated() && (
        // New recipes MUST have parentId (enforced by flow guards)
        request.resource.data.parentId != null && isOwnerOfParentProfile(request.resource.data.parentId)
      );
      allow update: if isAuthenticated() && (
        // Can update if existing recipe belongs to user and parentId doesn't change
        resource.data.parentId != null && isOwnerOfParentProfile(resource.data.parentId) &&
        request.resource.data.parentId == resource.data.parentId
      );
      allow delete: if isAuthenticated() && (
        resource.data.parentId != null && isOwnerOfParentProfile(resource.data.parentId)
      );
      allow list: if isAuthenticated() &&
        resource.data.parentId != null &&
        isOwnerOfParentProfile(resource.data.parentId);
    }

    // Collections - parent-only recipe groupings
    match /collections/{collectionId} {
      allow read: if isAuthenticated() &&
        resource.data.parentId != null &&
        isOwnerOfParentProfile(resource.data.parentId);
      allow create: if isAuthenticated() &&
        request.resource.data.parentId != null &&
        isOwnerOfParentProfile(request.resource.data.parentId);
      allow update: if isAuthenticated() &&
        resource.data.parentId != null &&
        isOwnerOfParentProfile(resource.data.parentId) &&
        request.resource.data.parentId == resource.data.parentId;
      allow delete: if isAuthenticated() &&
        resource.data.parentId != null &&
        isOwnerOfParentProfile(resource.data.parentId);
      allow list: if isAuthenticated() &&
        resource.data.parentId != null &&
        isOwnerOfParentProfile(resource.data.parentId);
    }

    // Kid-friendly recipes - only parent can access their kids' recipes (parentId-based only)
    match /kidRecipes/{kidRecipeId} {
      allow read: if isAuthenticated() && (
        // Parent can access via parentId (required - no legacy fallback)
        (resource.data.parentId != null && isOwnerOfParentProfile(resource.data.parentId)) ||
        // Kids can only access approved recipes
        (resource.data.kidId != null &&
          isParentOfKid(resource.data.kidId) &&
          resource.data.approvalStatus == 'approved')
      );
      allow create: if isAuthenticated() && (
        // New kidRecipes must use parentId (required - no legacy fallback)
        request.resource.data.parentId != null && isOwnerOfParentProfile(request.resource.data.parentId)
      );
      allow update: if isAuthenticated() && (
        // Parent can update via parentId - check both existing and new data
        (resource.data.parentId != null && isOwnerOfParentProfile(resource.data.parentId)) &&
        (request.resource.data.parentId != null && isOwnerOfParentProfile(request.resource.data.parentId)) &&
        // Only allow approval-related field changes and denormalized display fields
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'approvalStatus',
          'approvalReviewedAt',
          'approvalNotes',
          'isActive',
          'originalRecipeTitle',
          'originalRecipeImage',
          'originalRecipeUrl'
        ]))
      );
      allow delete: if isAuthenticated() && (
        // Parent can delete via parentId (required - no legacy fallback)
        resource.data.parentId != null && isOwnerOfParentProfile(resource.data.parentId)
      );
      allow list: if isAuthenticated();
    }

    // Global kid-friendly recipe cache - authenticated users can cache their own conversions
    match /kidRecipeCache/{cacheId} {
      allow read: if isAuthenticated() &&
        resource.data.parentId != null &&
        isOwnerOfParentProfile(resource.data.parentId);
      // Allow authenticated users to cache their own recipe conversions for performance (parentId-based only)
      allow write, create: if isAuthenticated() && (
        // Check that the cache entry belongs to the authenticated user (required - no legacy fallback)
        request.resource.data.parentId != null && isOwnerOfParentProfile(request.resource.data.parentId)
      );
    }

    // Cooking Sessions - only for kid's parent
    match /cookingSessions/{sessionId} {
      allow read, write, create: if isAuthenticated() &&
        isParentOfKid(resource.data.kidId || request.resource.data.kidId);
      allow list: if isAuthenticated() &&
        isParentOfKid(resource.data.kidId);
    }

    // Family Meals - only for family members
    match /familyMeals/{mealId} {
      allow read: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
      allow create: if isAuthenticated() &&
        isOwnerOfParentProfile(request.resource.data.parentId);
      allow update: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId) &&
        request.resource.data.parentId == resource.data.parentId;
      allow delete: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
      allow list: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
    }

    // Recipe Recommendations - read-only for authenticated users
    match /recipeRecommendations/{recommendationId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions should write recommendations
    }

    // Recipe sharing (sharedRecipes collection) - proper ownership validation
    match /sharedRecipes/{shareId} {
      allow read: if isAuthenticated() && (
        // Parent can read recipes shared with their kids
        (resource.data.kidId != null && isParentOfKid(resource.data.kidId)) ||
        // Parent can read recipes they shared
        (resource.data.parentId != null && isOwnerOfParentProfile(resource.data.parentId))
      );

      // Allow create - check the request data for new documents
      allow create: if isAuthenticated() && (
        // Parent creating their own shared recipe
        isOwnerOfParentProfile(request.resource.data.parentId)
      );

      // Allow update - check both existing and new data
      allow update: if isAuthenticated() && (
        // Original document belongs to user and new document still belongs to user
        isOwnerOfParentProfile(resource.data.parentId) &&
        isOwnerOfParentProfile(request.resource.data.parentId) &&
        request.resource.data.parentId == resource.data.parentId
      );

      // Allow delete - check existing document ownership
      allow delete: if isAuthenticated() && (
        isOwnerOfParentProfile(resource.data.parentId)
      );

      // Allow list for queries - parent ownership enforced per document
      allow list: if isAuthenticated() && (
        isOwnerOfParentProfile(resource.data.parentId)
      );
    }

    // Kid recipe ratings - parents can rate kid recipes they have access to
    match /kidRecipeRatings/{ratingId} {
      allow read: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
      allow create: if isAuthenticated() && (
        isOwnerOfParentProfile(request.resource.data.parentId)
      );
      allow update: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId) &&
        request.resource.data.parentId == resource.data.parentId;
      allow delete: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
      allow list: if isAuthenticated() && (
        isOwnerOfParentProfile(resource.data.parentId)
      );
    }

    // Step reports - kids and parents can report issues with recipe steps
    match /stepReports/{reportId} {
      allow read: if isAuthenticated() && (
        // Parent who created the report
        isOwnerOfParentProfile(resource.data.parentId) ||
        // Kid the recipe was for (via parent ownership)
        isParentOfKid(resource.data.kidId)
      );
      allow create: if isAuthenticated() && (
        isOwnerOfParentProfile(request.resource.data.parentId) ||
        isParentOfKid(request.resource.data.kidId)
      );
      allow update: if isAuthenticated() && (
        isOwnerOfParentProfile(resource.data.parentId) ||
        isParentOfKid(resource.data.kidId)
      ) && (
        request.resource.data.parentId == resource.data.parentId
      );
      allow delete: if isAuthenticated() && (
        isOwnerOfParentProfile(resource.data.parentId) ||
        isParentOfKid(resource.data.kidId)
      );
      allow list: if isAuthenticated() && (
        isOwnerOfParentProfile(resource.data.parentId) ||
        isParentOfKid(resource.data.kidId)
      );
    }

    // Kid Progress tracking - only accessible by parents of the kid
    match /kidProgress/{kidId} {
      allow read, write: if isAuthenticated() && isParentOfKid(kidId);
      allow create: if isAuthenticated() && isParentOfKid(kidId);
      allow list: if isAuthenticated() && isParentOfKid(kidId);
    }

    // Rate limiting collection for tracking usage quotas
    match /rateLimits/{userId} {
      allow read, write: if isOwner(userId);
      allow create: if isAuthenticated() && userId == request.auth.uid;
    }

    // COPPA Compliance: Parental Notice records
    match /parentalNotices/{noticeId} {
      allow read, write: if isAuthenticated() && (
        // Parent can access notices sent to them
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid
      );
      allow list: if isAuthenticated() && (
        resource.data.userId == request.auth.uid
      );
    }

    // Recipe Favorites - parents can manage their own favorites and their kids' favorites
    match /recipeFavorites/{favoriteId} {
      // Parents can manage favorites via parentId ownership
      allow read: if isAuthenticated() && (
        resource == null || isOwnerOfParentProfile(resource.data.parentId)
      );
      allow create: if isAuthenticated() &&
        isOwnerOfParentProfile(request.resource.data.parentId);
      allow update: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId) &&
        isOwnerOfParentProfile(request.resource.data.parentId) &&
        request.resource.data.parentId == resource.data.parentId;
      allow delete: if isAuthenticated() &&
        isOwnerOfParentProfile(resource.data.parentId);
    }

    // Beta feedback collection - users can create feedback, only admins can read/update
    match /betaFeedback/{feedbackId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      // Only Cloud Functions can read/update feedback for privacy
      allow read, write: if false;
    }

    // Error Reports - users can create error reports, only admins/cloud functions can read
    match /errorReports/{reportId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      // Only Cloud Functions can read/update error reports for privacy and security
      allow read, write: if false;
    }

    // User Sessions - track user behavior and app usage patterns
    match /userSessions/{sessionId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      // Only Cloud Functions can read/update sessions for analytics processing
      allow read, write: if false;
    }

    // Performance Metrics - monitor app performance and crashes
    match /performanceMetrics/{metricId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      // Only Cloud Functions can read/update performance data
      allow read, write: if false;
    }

    // Feature Usage - track which features are used most/least
    match /featureUsage/{usageId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      // Only Cloud Functions can read/update usage data for analytics
      allow read, write: if false;
    }

    // Analytics Events - generic analytics event tracking
    match /analyticsEvents/{eventId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      // Only Cloud Functions can read/update events for processing
      allow read, write: if false;
    }

    // Subscription data - user subscription plans and status
    match /subscriptions/{parentId} {
      // Users can read their own subscription
      allow read: if isAuthenticated() && isOwnerOfParentProfile(parentId);

      // Users can create their own free subscription on first login (beta phase)
      // This allows createFreeSubscription() to work from the client
      allow create: if isAuthenticated() &&
                       isOwnerOfParentProfile(parentId) &&
                       request.resource.data.plan == 'free' &&
                       request.resource.data.status in ['beta', 'active'] &&
                       request.resource.data.isBetaTester == true;

      // Only Cloud Functions can update/delete subscriptions
      // (for webhook handling from Stripe/Apple when payment is enabled)
      allow update, delete: if false;
    }

    // Usage Tracking - monthly quotas for imports and AI conversions
    match /usageTracking/{parentId} {
      // Users can read their own usage data
      allow read: if isAuthenticated() && isOwnerOfParentProfile(parentId);

      // Users and Cloud Functions can write (for creating/updating counters)
      allow write: if isAuthenticated() && isOwnerOfParentProfile(parentId);
    }

    // Deny all other access
    match /{path=**} {
      allow read, write: if false;
    }
  }
}
